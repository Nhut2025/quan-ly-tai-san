<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý tài sản</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background-color: #f0f8ff; padding: 20px; }
    h4.section-title { background-color: #007bff; color: white; padding: 10px; border-radius: 5px; margin-top: 30px; }
  </style>
</head>
<body>
  <h2 class="text-center text-primary mb-4">HỆ THỐNG QUẢN LÝ TÀI SẢN</h2>

  <!-- KHOA PHÒNG -->
  <h4 class="section-title">Quản lý Khoa phòng</h4>
  <div class="row mb-3">
    <div class="col-md-4"><input id="tenKhoaPhong" class="form-control" placeholder="Nhập tên khoa phòng mới" /></div>
    <div class="col-md-4"><button id="btnThemKhoa" class="btn btn-primary w-100">Thêm Khoa phòng</button></div>
    <div class="col-md-4">
      <select id="xoaPhongSelect" class="form-select"></select>
      <button id="btnXoaKhoa" class="btn btn-danger mt-2 w-100">Xóa Khoa phòng</button>
    </div>
  </div>

  <!-- NHẬP TÀI SẢN -->
  <h4 class="section-title">Nhập tài sản vào kho</h4>
  <div class="row mb-3">
    <div class="col-md-2"><input id="tenTaiSan" class="form-control" placeholder="Tên tài sản"></div>
    <div class="col-md-2"><input id="maTaiSan" class="form-control" placeholder="Mã tài sản"></div>
    <div class="col-md-2"><input id="soLuong" type="number" class="form-control" placeholder="Số lượng"></div>
    <div class="col-md-2"><input id="donGia" type="number" class="form-control" placeholder="Đơn giá"></div>
    <div class="col-md-2"><input id="thanhTien" type="number" class="form-control" placeholder="Thành tiền" readonly></div>
    <div class="col-md-2"><input id="ngayNhap" type="date" class="form-control"></div>
  </div>
  <div class="row mb-3">
    <div class="col-md-4"><select id="khoaNhap" class="form-select"><option disabled selected>-- Chọn Khoa phòng --</option></select></div>
    <div class="col-md-4"><button id="btnThemTaiSan" class="btn btn-success w-100">Thêm Tài Sản</button></div>
  </div>

 <!-- TÌM KIẾM & LỌC KHOA NHẬP -->
<div class="row mb-3">
  <div class="col-md-6">
    <input type="text" id="timTenTaiSan" class="form-control" placeholder="Tìm kiếm tài sản...">
  </div>
  <div class="col-md-6">
    <select id="locKhoaNhap" class="form-select">
      <option value="">-- Chọn Khoa phòng --</option>
    </select>
  </div>
</div> 



  <!-- LỌC NGÀY & XUẤT EXCEL NHẬP -->
  <div class="row mb-3">
    <div class="col-md-3"><input type="date" id="tuNgayNhap" class="form-control"></div>
    <div class="col-md-3"><input type="date" id="denNgayNhap" class="form-control"></div>
    <div class="col-md-3"><button class="btn btn-outline-success mt-1" onclick="locVaXuatExcelNhap()">Lọc & Xuất Excel Kho Nhập</button></div>
  </div>
 


  <table class="table table-bordered table-hover">
    <thead><tr><th>STT</th><th>Tên</th><th>Mã</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th>Ngày</th><th>Khoa</th><th>Hành động</th></tr></thead>
    <tbody id="tableKhoNhap"></tbody>
  </table>

  <!-- XUẤT KHO -->
  <h4 class="section-title">Xuất tài sản khỏi kho</h4>
  <div class="row mb-3">
    <div class="col-md-2"><input id="maXuat" class="form-control" placeholder="Mã tài sản"></div>
    <div class="col-md-2"><input id="slXuat" type="number" class="form-control" placeholder="Số lượng xuất"></div>
    <div class="col-md-2"><input id="ngayXuat" type="date" class="form-control"></div>
    <div class="col-md-3"><select id="khoXuat" class="form-select"></select><option value=""> -- Chọn Khoa xuất --</option></div>
    <div class="col-md-3"><select id="khoNhap" class="form-select"></select><option value=""> -- Chọn Khoa nhập --</option></div>
  </div>
  <div class="row mb-3"><div class="col-md-3"><button id="btnXuatKho" class="btn btn-danger w-100">Xuất kho</button></div></div>

  <!-- LỌC NGÀY & XUẤT EXCEL XUẤT -->
  <div class="row mb-3">
    <div class="col-md-3"><input type="date" id="tuNgayXuat" class="form-control"></div>
    <div class="col-md-3"><input type="date" id="denNgayXuat" class="form-control"></div>
    <div class="col-md-3"><button class="btn btn-outline-success mt-1" onclick="locVaXuatExcelXuat()">Lọc & Xuất Excel Kho Xuất</button></div>
  </div>

  <table class="table table-bordered table-hover">
    <thead><tr><th>STT</th><th>Mã</th><th>SL Xuất</th><th>Ngày</th><th>Kho xuất</th><th>Kho nhập</th><th>Hành động</th></tr></thead>
    <tbody id="tableXuatKho"></tbody>
  </table>
<script type="module">

function dinhDangNgay(ngayISO) {
  if (!ngayISO) return "";
  const [y, m, d] = ngayISO.split("-");
  return `${d}-${m}-${y}`;
}

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import {
    getDatabase, ref, set, push, onValue, remove, update, get, child
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAM8oA5Ix4go4aEQDG_y6O8CSf1MmXhv0A",
    authDomain: "quanlytaisan-e63af.firebaseapp.com",
    databaseURL: "https://quanlytaisan-e63af-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "quanlytaisan-e63af",
    storageBucket: "quanlytaisan-e63af.appspot.com",
    messagingSenderId: "383475000578",
    appId: "1:383475000578:web:3e0689512fa3f5f50f8e1b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Tải danh sách khoa phòng
  function taiKhoaPhong() {
    onValue(ref(db, "phongbans"), (snap) => {
      const data = snap.val();
      const selectIds = ["khoaNhap", "khoXuat", "khoNhap", "xoaPhongSelect"];
      selectIds.forEach(id => {
		  
		  if (document.getElementById("locKhoaNhap")) {
  const locKhoa = document.getElementById("locKhoaNhap");
  locKhoa.innerHTML = `<option value="">-- Chọn Khoa phòng --</option>`;
  for (let key in data) {
    locKhoa.innerHTML += `<option>${data[key]}</option>`;
  }
}

        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = `<option disabled selected>-- Chọn Khoa phòng --</option>`;
        for (let key in data) {
          sel.innerHTML += `<option>${data[key]}</option>`;
        }
      });
    });
  }
  taiKhoaPhong();

  // Thêm khoa
  btnThemKhoa.onclick = () => {
    const val = tenKhoaPhong.value.trim();
    if (!val) return alert("Nhập tên khoa");
    const newRef = push(ref(db, "phongbans"));
    set(newRef, val);
    tenKhoaPhong.value = "";
  };

  // Xóa khoa
  btnXoaKhoa.onclick = () => {
    const chon = xoaPhongSelect.value;
    if (!chon) return alert("Chọn khoa phòng để xóa");

    get(ref(db, "phongbans")).then((snap) => {
      const data = snap.val();
      for (let key in data) {
        if (data[key] === chon) {
          remove(ref(db, `phongbans/${key}`));
          alert("Đã xóa khoa phòng");
          break;
        }
      }
    });
  };

  // Thành tiền tự động
  soLuong.oninput = donGia.oninput = () => {
    const sl = +soLuong.value || 0;
    const dg = +donGia.value || 0;
    thanhTien.value = sl * dg;
  };

  // Thêm tài sản
  btnThemTaiSan.onclick = () => {
    const ten = tenTaiSan.value.trim();
    const ma = maTaiSan.value.trim();
    const sl = +soLuong.value;
    const dg = +donGia.value;
    const tt = sl * dg;
    const ngay = ngayNhap.value;
    const khoa = khoaNhap.value;
    if (!ten || !ma || !sl || !dg || !ngay || !khoa) return alert("Nhập đủ thông tin");

    const newRef = push(ref(db, "taisans"));
    set(newRef, { ten, ma, sl, dg, tt, ngay, khoa });

    ["tenTaiSan", "maTaiSan", "soLuong", "donGia", "thanhTien", "ngayNhap"].forEach(id => document.getElementById(id).value = "");
  };

  // Hiển thị tài sản
  onValue(ref(db, "taisans"), (snap) => {
    const data = snap.val();
    const tb = document.getElementById("tableKhoNhap");
    tb.innerHTML = "";
    let stt = 1;
    for (let key in data) {
      const { ten, ma, sl, dg, tt, ngay, khoa } = data[key];
      tb.innerHTML += `
        <tr><td>${stt++}</td><td>${ten}</td><td>${ma}</td><td>${sl}</td><td>${dg}</td><td>${tt}</td><td>${dinhDangNgay(ngay)}</td><td>${khoa}</td>
        <td><button class="btn btn-warning btn-sm" onclick="suaTaiSan('${key}')">Sửa</button>
        <button class="btn btn-danger btn-sm" onclick="xoaTaiSan('${key}')">Xóa</button></td></tr>
      `;
    }
  });

  // Sửa tài sản
  window.suaTaiSan = (key) => {
    get(child(ref(db), `taisans/${key}`)).then((snap) => {
      const ts = snap.val();
      tenTaiSan.value = ts.ten;
      maTaiSan.value = ts.ma;
      soLuong.value = ts.sl;
      donGia.value = ts.dg;
      thanhTien.value = ts.tt;
      ngayNhap.value = ts.ngay;
      khoaNhap.value = ts.khoa;
      btnThemTaiSan.style.display = "none";
      if (!document.getElementById("btnCapNhat")) {
        const btn = document.createElement("button");
        btn.id = "btnCapNhat";
        btn.className = "btn btn-success w-100 mt-2";
        btn.innerText = "Cập nhật";
        btn.onclick = () => {
          const ten = tenTaiSan.value, ma = maTaiSan.value, sl = +soLuong.value, dg = +donGia.value, ngay = ngayNhap.value, khoa = khoaNhap.value;
          update(ref(db, `taisans/${key}`), { ten, ma, sl, dg, tt: sl * dg, ngay, khoa });
          btn.remove(); btnThemTaiSan.style.display = "block";
          ["tenTaiSan", "maTaiSan", "soLuong", "donGia", "thanhTien", "ngayNhap"].forEach(id => document.getElementById(id).value = "");
        };
        btnThemTaiSan.parentNode.appendChild(btn);
      }
    });
  };

  // Xóa tài sản
  window.xoaTaiSan = (key) => {
    if (confirm("Xóa tài sản này?")) remove(ref(db, `taisans/${key}`));
  };

  // Xuất kho
  btnXuatKho.onclick = () => {
  const ma = maXuat.value.trim(), slXuatVal = +slXuat.value, ngay = ngayXuat.value, khoX = khoXuat.value, khoN = khoNhap.value;
  if (!ma || !slXuatVal || !ngay || !khoX || !khoN) return alert("Nhập đủ thông tin");

  get(ref(db, "taisans")).then((snap) => {
    const data = snap.val();
    let found = false;
    for (let key in data) {
      const ts = data[key];
      if (ts.ma === ma && ts.khoa === khoX) {
        if (ts.sl < slXuatVal) return alert("Không đủ số lượng");
        update(ref(db, `taisans/${key}`), {
          sl: ts.sl - slXuatVal,
          tt: (ts.sl - slXuatVal) * ts.dg
        });
        const newRef = push(ref(db, "xuatkho"));
        set(newRef, { ma, slXuat: slXuatVal, ngay, khoXuat: khoX, khoNhap: khoN });

        // Kiểm tra tồn tại ở kho nhập (tên + mã)
        let daCong = false;
        for (let key2 in data) {
          const ts2 = data[key2];
          if (ts2.ma === ma && ts2.ten === ts.ten && ts2.khoa === khoN) {
            const slMoi = ts2.sl + slXuatVal;
            const ttMoi = slMoi * ts2.dg;
            update(ref(db, `taisans/${key2}`), { sl: slMoi, tt: ttMoi });
            daCong = true;
            break;
          }
        }

        if (!daCong) {
          const newNhapRef = push(ref(db, "taisans"));
          set(newNhapRef, {
            ten: ts.ten,
            ma: ts.ma,
            sl: slXuatVal,
            dg: ts.dg,
            tt: slXuatVal * ts.dg,
            ngay,
            khoa: khoN
          });
        }

        found = true;
        break;
      }
    }
    if (!found) alert("Không tìm thấy tài sản phù hợp");
  });
};


  // Hiển thị xuất kho
  onValue(ref(db, "xuatkho"), (snap) => {
    const data = snap.val();
    const tb = document.getElementById("tableXuatKho");
    tb.innerHTML = "";
    let stt = 1;
    for (let key in data) {
      const { ma, slXuat, ngay, khoXuat, khoNhap } = data[key];
      tb.innerHTML += `<tr><td>${stt++}</td><td>${ma}</td><td>${slXuat}</td><td>${dinhDangNgay(ngay)}</td><td>${khoXuat}</td><td>${khoNhap}</td>
        <td><button class="btn btn-danger btn-sm" onclick="xoaXuatKho('${key}')">Xóa</button></td></tr>`;
    }
  });

  window.xoaXuatKho = (key) => {
    if (confirm("Xóa phiếu xuất này?")) remove(ref(db, `xuatkho/${key}`));
  };

  // Lọc & xuất Excel
  function parseDate(str) {
    const [y, m, d] = str.split("-");
    return new Date(+y, m - 1, +d);
  }

  window.locVaXuatExcelNhap = () => {
    const tu = parseDate(tuNgayNhap.value), den = parseDate(denNgayNhap.value);
    get(ref(db, "taisans")).then((snap) => {
      const data = snap.val();
      const rows = [["Tên", "Mã", "SL", "Đơn giá", "Thành tiền", "Ngày", "Khoa"]];
      for (let key in data) {
        const ts = data[key];
        const ngay = parseDate(ts.ngay);
        if (ngay >= tu && ngay <= den) rows.push([ts.ten, ts.ma, ts.sl, ts.dg, ts.tt, dinhDangNgay(ts.ngay), ts.khoa]);
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "KhoNhap");
      XLSX.writeFile(wb, `Phieu_Nhap_${tuNgayNhap.value}_den_${denNgayNhap.value}.xlsx`);
    });
  };

  window.locVaXuatExcelXuat = () => {
    const tu = parseDate(tuNgayXuat.value), den = parseDate(denNgayXuat.value);
    get(ref(db, "xuatkho")).then((snap) => {
      const data = snap.val();
      const rows = [["Mã", "SL xuất", "Ngày", "Kho xuất", "Kho nhập"]];
      for (let key in data) {
        const x = data[key];
        const ngay = parseDate(x.ngay);
        if (ngay >= tu && ngay <= den) rows.push([x.ma, x.slXuat, dinhDangNgay(x.ngay), x.khoXuat, x.khoNhap]);
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "KhoXuat");
      XLSX.writeFile(wb, `Phieu_Xuat_${tuNgayXuat.value}_den_${denNgayXuat.value}.xlsx`);
    });
  };
  
  function hienThiTaiSan(data) {
  const keyword = document.getElementById("timTenTaiSan")?.value.toLowerCase() || "";
  const khoaLoc = document.getElementById("locKhoaNhap")?.value || "";
  const tb = document.getElementById("tableKhoNhap");
  tb.innerHTML = "";
  let stt = 1;
  for (let key in data) {
    const { ten, ma, sl, dg, tt, ngay, khoa } = data[key];
    const matchTen = ten.toLowerCase().includes(keyword);
    const matchKhoa = khoaLoc === "" || khoa === khoaLoc;
    if (matchTen && matchKhoa) {
      tb.innerHTML += `<tr><td>${stt++}</td><td>${ten}</td><td>${ma}</td><td>${sl}</td><td>${dg}</td><td>${tt}</td><td>${dinhDangNgay(ngay)}</td><td>${khoa}</td>
      <td><button class='btn btn-warning btn-sm' onclick="suaTaiSan('${key}')">Sửa</button>
      <button class='btn btn-danger btn-sm' onclick="xoaTaiSan('${key}')">Xóa</button></td></tr>`;
    }
  }
}

onValue(ref(db, "taisans"), (snap) => {
  const data = snap.val();
  window._dataTaiSan = data;
  hienThiTaiSan(data);
});

document.getElementById("timTenTaiSan")?.addEventListener("input", () => {
  hienThiTaiSan(window._dataTaiSan || {});
});

document.getElementById("locKhoaNhap")?.addEventListener("change", () => {
  hienThiTaiSan(window._dataTaiSan || {});
});

</script>

	<div id="Bottom" style="color: #007bff;font-size: 21px; font-weight: bold;">
    <br/>
    <center>
      HỆ THỐNG QUẢN LÝ TÀI SẢN TẠI TRUNG TÂM Y TẾ KHU VỰC LẤP VÒ<br />
      THIẾT KẾ BỞI: TỔ TIN HỌC - PHÒNG KẾ HOẠCH NGHIỆP VỤ <br />
    </center>
  </div>
	
</body>
</html>

